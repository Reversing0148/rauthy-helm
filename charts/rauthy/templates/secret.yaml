{{- if not .Values.externalSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "rauthy.fullname" . }}-config
  labels:
    {{- include "rauthy.labels" . | nindent 4 }}
type: Opaque
stringData:
  config.toml: |-
    [server]
    scheme = {{ .Values.service.scheme | quote }}
    pub_url = {{ include "rauthy.domainName" . | quote }}
    {{- if eq .Values.service.type "ClusterIP" }}
    proxy_mode = true
    trusted_proxies = ["10.0.0.0/8", "192.168.0.0/24", "172.16.0.0/12"]
    {{- end}}
    {{- if .Values.metrics.enabled }}
    metrics_enable = true
    metrics_port = {{ int .Values.metrics.port }}
    {{- end }}

    [cluster]
    node_id_from = "k8s"
    {{- $root := . }}
    {{- $headless := include "rauthy.fullname" . | printf "%s-headless" }}
    {{- if gt (int .Values.replicaCount) 1 }}
    nodes = [
      {{- range $i, $ := until (int $root.Values.replicaCount) }}
        "{{ add $i 1 }} {{ $root.Release.Name }}-{{ $i }}.{{ $headless }}:{{ $root.Values.headlessService.ports.raft }} {{ $root.Release.Name }}-{{ $i }}.{{ $headless }}:{{ $root.Values.headlessService.ports.api }}",
      {{- end }}
    ]
    {{- else }}
    nodes = [
        "1 localhost:{{ $root.Values.headlessService.ports.raft }} localhost:{{ $root.Values.headlessService.ports.api }}"
    ]
    log_sync = "immediate"
    {{- end }}
    
    secret_raft = "{{ randAlphaNum 48 }}"
    secret_api = "{{ randAlphaNum 48 }}"

    [encryption]
    {{- $randAlphaNum16 := randAlphaNum 16 }}
    keys = [
        "{{ printf "%s/%s" ($randAlphaNum16) (b64enc (randAlphaNum 32)) }}"
    ]
    key_active = "{{ $randAlphaNum16 }}"

    [bootstrap]
    admin_email = "admin@localhost"

    [webauthn]
    rp_id = {{ include "rauthy.domainName" . | quote }}
    rp_origin = {{ include "rauthy.rpOrigin" . | quote }}
    rp_name = "Rauthy"
{{- end }}
